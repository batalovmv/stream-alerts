name: CI / Deploy

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  NODE_VERSION: '20'
  APP_DIR: /opt/memelab-notify
  PM2_NAME: memelab-notify
  HEALTH_PORT: 3003

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    name: Build & Type-check
    runs-on: [self-hosted, linux, x64]
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4
        with:
          version: 10

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - run: pnpm install --frozen-lockfile

      - name: Generate Prisma Client
        run: pnpm --filter backend exec prisma generate

      - name: Run tests
        run: pnpm --filter backend test

      - name: Build backend
        run: pnpm --filter backend build

      - name: Build frontend
        run: pnpm --filter frontend build

  deploy:
    name: Deploy to VPS
    runs-on: [self-hosted, linux, x64]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    needs: [build]
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4
        with:
          version: 10

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Deploy
        shell: bash
        run: |
          set -euo pipefail

          APP_DIR="${{ env.APP_DIR }}"
          BACKEND_DIR="$APP_DIR/apps/backend"
          PM2_NAME="${{ env.PM2_NAME }}"
          HEALTH_PORT="${{ env.HEALTH_PORT }}"

          if [ ! -d "$APP_DIR" ]; then
            echo "APP_DIR $APP_DIR not found"
            exit 1
          fi

          # Save previous SHA for potential rollback
          PREV_SHA=""
          if [ -d "$APP_DIR/.git" ]; then
            PREV_SHA="$(git -C "$APP_DIR" rev-parse HEAD 2>/dev/null || true)"
          fi

          git config --global --add safe.directory "$APP_DIR"

          # Sync code (preserve .env, node_modules, .npmrc)
          echo "Syncing repo -> $APP_DIR ..."
          sudo rsync -a --delete \
            --exclude node_modules \
            --exclude .env \
            --exclude .npmrc \
            --exclude apps/backend/.env \
            ./ "$APP_DIR/"

          # Fix ownership after sudo rsync (runner is deploy, not root)
          sudo chown -R "$(whoami):$(whoami)" "$APP_DIR"

          cd "$APP_DIR"

          # Install dependencies
          pnpm install --frozen-lockfile

          # Generate Prisma client
          pnpm --filter backend exec prisma generate

          # Apply database migrations (safe for production â€” uses migration history)
          # Load DATABASE_URL from .env for Prisma migrate
          if [ -f "$BACKEND_DIR/.env" ]; then
            set -a
            . "$BACKEND_DIR/.env"
            set +a
          fi
          echo "Applying database migrations..."
          if ! pnpm --filter backend exec prisma migrate deploy 2>&1; then
            echo "Database migration failed!"
            exit 1
          fi

          # Build
          pnpm --filter backend build
          pnpm --filter frontend build

          # Restart backend via PM2
          if pm2 describe "$PM2_NAME" > /dev/null 2>&1; then
            pm2 restart "$PM2_NAME" --update-env
          else
            pm2 start "$APP_DIR/ecosystem.config.cjs" --update-env
          fi
          pm2 save

          # Healthcheck
          echo "Waiting for healthcheck on :${HEALTH_PORT} ..."
          HEALTH_OK=0
          for i in $(seq 1 15); do
            if curl -fsS --max-time 2 "http://127.0.0.1:${HEALTH_PORT}/api/health" >/dev/null 2>&1; then
              HEALTH_OK=1
              break
            fi
            sleep 2
          done

          if [ "$HEALTH_OK" != "1" ]; then
            echo "Healthcheck failed! Recent logs:"
            pm2 logs "$PM2_NAME" --lines 30 --nostream || true

            # Attempt rollback
            if [ -n "$PREV_SHA" ]; then
              echo "Rolling back to $PREV_SHA ..."
              git -C "$APP_DIR" checkout "$PREV_SHA"
              pnpm install --frozen-lockfile
              pnpm --filter backend exec prisma generate
              # Note: database migrations are forward-only; manual intervention may be needed
              # if the failed deploy included destructive schema changes
              pnpm --filter backend build
              pnpm --filter frontend build
              pm2 restart "$PM2_NAME" --update-env
              pm2 save
              sudo nginx -t && sudo systemctl reload nginx || true
            fi
            exit 1
          fi

          # Reload nginx (in case frontend changed)
          sudo nginx -t && sudo systemctl reload nginx || true

          echo "Deployed successfully"
          echo "   Backend: http://127.0.0.1:${HEALTH_PORT}/api/health"
          echo "   Frontend: https://notify.memelab.ru"
